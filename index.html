<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <meta name="theme-color" content="#83977c"/>
    <title>DCH ‚Äì Dhamnod Coffee House</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

    <style>
        :root{ --color-cream:#f7f3e8; --color-espresso:#382b22; --color-sage:#a6b49e; --color-dark-sage:#83977c; --font-title:'Georgia', serif; --font-body:'Helvetica Neue', sans-serif; }
        * { box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
        body{ margin:0; padding:0; background-color:var(--color-cream); color:var(--color-espresso); font-family:var(--font-body); }
        
        /* HEADER */
        .header{ position:fixed; top:0; left:0; width:100%; background-color:var(--color-cream); padding:10px 15px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 2px 4px rgba(56,43,34,0.1); z-index:1000; }
        .cafe-title { font-family:var(--font-title); font-size:1.4rem; font-weight:700; margin:0; display:flex; align-items:center; }
        .header-logo-img { width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; border: 2px solid var(--color-espresso); object-fit: cover; }
        .nav-actions{ display: flex; gap: 8px; align-items: center; }
        .nav-button{ background-color:var(--color-sage); color:white; border:none; padding:8px 12px; border-radius:6px; font-size:0.9rem; font-weight:600; cursor: pointer; }

        /* PAGES */
        .page{ min-height:100vh; padding-top:80px; padding-bottom: 40px; display:none; }
        .page.active { display: block; animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* MENU & CART */
        .cart-container { position: relative; display: inline-block; }
        .cart-button{ background: none; border: none; font-size: 1.4rem; padding: 0 5px; cursor: pointer; }
        #cart-count { position: absolute; top: -5px; right: -8px; background: #e74c3c; color: white; border-radius: 50%; padding: 3px; font-size: 0.7rem; font-weight: 700; min-width: 18px; text-align: center; display:none; }
        #cart-count.visible { display: block; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal-overlay.open { display: flex; }
        .cart-modal-content { background-color: var(--color-cream); padding: 25px; border-radius: 16px; width: 90%; max-width: 400px; max-height: 85vh; display: flex; flex-direction: column; }
        
        /* MENU ITEMS */
        .category-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(100px,1fr)); gap:12px; margin:20px 20px; }
        .category-button{ background:white; border:1px solid var(--color-sage); padding:10px; height:90px; border-radius:12px; display:flex; flex-direction:column; justify-content:center; align-items:center; cursor: pointer; }
        .category-button.active-category { background: var(--color-dark-sage); color: white; font-weight: bold; }
        
        .menu-section { display: none; padding: 0 20px 50px 20px; }
        .menu-section.active { display: block; }
        .section-header { border-bottom: 2px solid var(--color-sage); padding-bottom: 10px; margin-bottom: 15px; font-family: var(--font-title); }
        
        .menu-item-card { display:flex; justify-content:space-between; align-items:center; padding:15px; margin-bottom:12px; background:white; border-radius:8px; box-shadow:0 1px 3px rgba(0,0,0,0.1); }
        .item-name { font-weight: bold; font-size: 1.05rem; }
        .item-desc { font-size: 0.85rem; color: #666; margin-top: 4px; }
        .item-price { font-weight: bold; color: var(--color-dark-sage); }
        .add-btn { background:var(--color-sage); color:white; border:none; padding:5px 10px; border-radius:4px; font-weight:bold; cursor: pointer; }

        /* TOAST */
        .toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 12px 24px; border-radius: 50px; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        .toast.show { opacity: 1; }
        
        /* Loading */
        .loader { text-align: center; padding: 20px; color: var(--color-sage); font-weight: bold; }
    </style>
</head>
<body>

<div id="item-toast" class="toast"></div>

<div id="home-page" class="page active">
  <header class="header">
    <div class="cafe-title"><img src="logo.png" class="header-logo-img"> DCH Cafe</div>
    <div class="nav-actions">
        <button class="nav-button" onclick="showMenu()">Menu</button>
    </div>
  </header>
  <div style="padding: 20px; text-align: center;">
    <h2>Welcome to DCH</h2>
    <p>Delicious food & coffee in Dhamnod.</p>
    <img src="special.jpg" style="width:100%; border-radius:10px; margin-bottom:20px;">
    <button class="nav-button" style="background:var(--color-espresso); width:100%; padding:15px;" onclick="showMenu()">Order Now</button>
  </div>
</div>

<div id="menu-page" class="page">
  <header class="header">
    <h1 class="cafe-title">Menu</h1>
    <div class="nav-actions">
        <div class="cart-container">
            <button class="cart-button" onclick="showCart()">üõí</button>
            <span id="cart-count">0</span>
        </div>
        <button class="nav-button" onclick="showHome()">Home</button>
    </div>
  </header>

  <div id="category-buttons" class="category-grid">
      <button class="category-button" onclick="filterCategory('sandwiches')">ü•™ Sandwiches</button>
      <button class="category-button" onclick="filterCategory('pizza')">üçï Pizza</button>
      <button class="category-button" onclick="filterCategory('burger')">üçî Burger</button>
      <button class="category-button" onclick="filterCategory('pasta')">üçù Pasta</button>
      <button class="category-button" onclick="filterCategory('chinese')">ü•° Chinese</button>
      <button class="category-button" onclick="filterCategory('fries')">üçü Fries</button>
      <button class="category-button" onclick="filterCategory('barbeque')">üç¢ Barbeque</button>
      <button class="category-button" onclick="filterCategory('momos')">ü•ü Momos</button>
      <button class="category-button" onclick="filterCategory('maggi')">üçú Maggi</button>
      <button class="category-button" onclick="filterCategory('tea')">üçµ Tea</button>
      <button class="category-button" onclick="filterCategory('shakes')">ü•õ Shakes</button>
      <button class="category-button" onclick="filterCategory('dch_specials')">üßá Specials</button>
      <button class="category-button" onclick="filterCategory('coffee')">‚òï Hot Coffee</button>
      <button class="category-button" onclick="filterCategory('cold_coffee')">üßä Cold Coffee</button>
      <button class="category-button" onclick="filterCategory('mocktails')">üçπ Mocktails</button>
      <button class="category-button" onclick="filterCategory('shots')">ü•É Shots</button>
  </div>

  <div id="loading-indicator" class="loader">Loading Menu...</div>

  <div id="menu-container">
      </div>
</div>

<div id="cart-modal" class="modal-overlay">
    <div class="cart-modal-content">
        <div style="display:flex; justify-content:space-between; border-bottom:1px solid #ccc; padding-bottom:10px;">
            <h3>Your Order</h3><button onclick="closeModal()" style="background:none; border:none; font-size:2rem;">√ó</button>
        </div>
        <div style="flex-grow:1; overflow-y:auto; padding:10px 0;">
            <ul id="cart-items-list" style="padding:0; list-style:none;"></ul>
            <div id="empty-cart-msg" style="text-align:center; padding:20px;">Cart is empty</div>
        </div>
        <div id="cart-footer"></div>
    </div>
</div>

<script>
    // --- SETTINGS ---
    const sheetCsvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQysn0Aj4LdO3zWXYRqmyZInqcq0EPS6cPGRlccczj0g9qT3LPo0Kn0424C3XSQ45StT6c8wocbnQy6/pub?output=csv';
    
    let allMenuItems = [];
    let cart = [];

    // --- INITIALIZATION ---
    window.addEventListener('load', () => {
        // 1. Force Remove Old Service Workers (Fixes the "Stuck Data" issue)
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(function(registrations) {
                for(let registration of registrations) {
                    registration.unregister();
                } 
            });
        }
        
        // 2. Fetch New Data
        fetchMenu();
    });

    function fetchMenu() {
        const loader = document.getElementById('loading-indicator');
        
        // Add random number to URL to prevent caching
        const noCacheUrl = sheetCsvUrl + "&t=" + Date.now();

        Papa.parse(noCacheUrl, {
            download: true, header: true,
            complete: function(results) {
                allMenuItems = results.data; // Save all data
                loader.style.display = 'none';
                
                // Show first category by default or let user choose
                // For now, let's just wait for user click
            },
            error: function(err) {
                loader.textContent = "Error loading menu. Check connection.";
            }
        });
    }

    // --- DISPLAY LOGIC ---
    // Mapping messy sheet names to clean IDs
    const categoryMap = {
        "sandwiches": "sandwiches", "sandwich": "sandwiches",
        "pizza": "pizza", "pizzas": "pizza",
        "burger": "burger", "burgers": "burger",
        "pasta": "pasta", "chinese": "chinese",
        "fries": "fries", "french fries": "fries",
        "barbeque": "barbeque", "bbq": "barbeque",
        "momos": "momos", "maggi": "maggi",
        "tea": "tea", "chai": "tea",
        "shakes": "shakes", "shake": "shakes",
        "dch specials": "dch_specials", "specials": "dch_specials",
        "coffee": "coffee", "hot coffee": "coffee",
        "cold coffee": "cold_coffee", "cold_coffee": "cold_coffee",
        "mocktails": "mocktails", "shots": "shots"
    };

    function filterCategory(catKey) {
        const container = document.getElementById('menu-container');
        container.innerHTML = ''; // Clear previous items (Fixes duplicate issue)
        
        // Highlight Button
        document.querySelectorAll('.category-button').forEach(b => b.classList.remove('active-category'));
        // (Optional: add active class to clicked button if passed)

        // Create Section Header
        const sectionDiv = document.createElement('div');
        sectionDiv.className = 'menu-section active';
        sectionDiv.innerHTML = `<h3 class="section-header">${catKey.toUpperCase().replace('_', ' ')}</h3>`;
        
        let count = 0;

        allMenuItems.forEach(row => {
            const vals = Object.values(row);
            if(vals.length < 3) return;

            // Normalize category from sheet
            let sheetCat = vals[0] ? vals[0].toString().toLowerCase().trim() : '';
            let mappedCat = categoryMap[sheetCat] || sheetCat;

            if(mappedCat === catKey) {
                count++;
                const name = vals[1];
                const price = vals[2];
                const desc = vals[3] || '';
                
                const itemHTML = `
                <div class="menu-item-card">
                    <div>
                        <div class="item-name">${name}</div>
                        <div class="item-desc">${desc}</div>
                    </div>
                    <div style="text-align:right;">
                        <div class="item-price">‚Çπ${price}</div>
                        <button class="add-btn" onclick="addToOrder('${name.replace(/'/g, "\\'")}', ${price})">ADD</button>
                    </div>
                </div>`;
                sectionDiv.innerHTML += itemHTML;
            }
        });

        if(count === 0) {
            sectionDiv.innerHTML += `<p style="text-align:center; color:#999;">No items found in this category.</p>`;
        }
        
        container.appendChild(sectionDiv);
        
        // Scroll to menu
        document.getElementById('category-buttons').scrollIntoView({behavior:'smooth'});
    }

    // --- CART LOGIC ---
    function addToOrder(name, price) {
        const item = cart.find(i => i.name === name);
        if(item) item.quantity++;
        else cart.push({name, price, quantity: 1});
        
        showToast(`${name} added!`);
        updateCartCount();
    }

    function updateCartCount() {
        const count = document.getElementById('cart-count');
        const total = cart.reduce((sum, i) => sum + i.quantity, 0);
        count.textContent = total;
        if(total > 0) count.classList.add('visible');
        else count.classList.remove('visible');
    }

    function renderCart() {
        const list = document.getElementById('cart-items-list');
        const footer = document.getElementById('cart-footer');
        const empty = document.getElementById('empty-cart-msg');
        
        if(cart.length === 0) {
            list.innerHTML = ''; empty.style.display='block'; footer.innerHTML=''; return;
        }
        empty.style.display='none';
        
        let total = 0;
        list.innerHTML = cart.map(item => {
            total += item.price * item.quantity;
            return `<li style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px dashed #ddd;">
                <div><b>${item.name}</b> <br> <small>‚Çπ${item.price} x ${item.quantity}</small></div>
                <button onclick="removeItem('${item.name}')" style="color:red; background:none; border:none; font-weight:bold;">Remove</button>
            </li>`;
        }).join('');
        
        footer.innerHTML = `
            <div style="display:flex; justify-content:space-between; font-weight:bold; margin-top:15px; font-size:1.1rem;">
                <span>Total:</span><span>‚Çπ${total}</span>
            </div>
            <button onclick="orderWhatsApp()" style="width:100%; background:#25D366; color:white; border:none; padding:12px; border-radius:8px; font-weight:bold; margin-top:10px;">Order on WhatsApp</button>
        `;
    }

    function removeItem(name) {
        const idx = cart.findIndex(i => i.name === name);
        if(idx > -1) cart.splice(idx, 1); // Remove item completely
        updateCartCount(); renderCart();
    }

    function orderWhatsApp() {
        if(cart.length===0) return;
        let msg = "*Order for DCH Cafe:* \n";
        let total = 0;
        cart.forEach(i => { msg += `${i.name} (x${i.quantity})\n`; total += i.price * i.quantity; });
        msg += `\n*Total: ‚Çπ${total}*`;
        window.open(`https://wa.me/918982628715?text=${encodeURIComponent(msg)}`, '_blank');
    }

    function showToast(msg) {
        const t = document.getElementById('item-toast');
        t.textContent = msg; t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 2000);
    }

    // --- NAVIGATION ---
    function showMenu() {
        document.getElementById('home-page').classList.remove('active');
        document.getElementById('menu-page').classList.add('active');
    }
    function showHome() {
        document.getElementById('menu-page').classList.remove('active');
        document.getElementById('home-page').classList.add('active');
    }
    function showCart() { renderCart(); document.getElementById('cart-modal').classList.add('open'); }
    function closeModal() { document.getElementById('cart-modal').classList.remove('open'); }

</script>
</body>
</html>

